name: Streamed Hashcat Cracking

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["Streamed Hashcat Cracking"]
    types: [completed]

jobs:
  crack:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y hashcat p7zip-full

      - name: Restore progress
        uses: actions/download-artifact@v4
        with:
          name: progress
        continue-on-error: true

      - name: Read progress
        id: read
        run: |
          if [ -f progress.txt ]; then
            START=$(cat progress.txt)
          else
            START=1
          fi
          echo "start=$START" >> $GITHUB_OUTPUT

      - name: Stream dictionary chunk and crack
        run: |
          START=${{ steps.read.outputs.start }}
          CHUNK=200000   # 每次跑 20 万行，可调大或调小
          END=$((START + CHUNK))

          echo "本次处理行号: $START 到 $END"

          # 流式读取 Weakpass 4（不下载、不解压）
          curl -L "https://download.weakpass.com/wordlists/2025/weakpass_4.merged.txt.7z" \
            | 7z x -si -so \
            | sed -n "${START},${END}p" \
            > dict_chunk.txt

          echo "开始 Hashcat..."

          hashcat -m 22000 -a 0 -w 3 hs/wifi-01.hc22000 dict_chunk.txt --potfile-disable -o result.txt

          echo $END > progress.txt

      - name: Upload progress
        uses: actions/upload-artifact@v4
        with:
          name: progress
          path: progress.txt
