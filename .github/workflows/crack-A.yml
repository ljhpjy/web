name: Crack A

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["Crack B"]
    types: [completed]

jobs:
  crack:
    runs-on: ubuntu-latest
    timeout-minutes: 350

    steps:
      - uses: actions/checkout@v3

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y hashcat p7zip-full

      - name: Download progress
        uses: actions/download-artifact@v4
        with:
          name: progress
        continue-on-error: true

      - name: Read progress
        id: read
        run: |
          if [ -f progress.txt ]; then
            START=$(cat progress.txt)
          else
            START=1
          fi
          echo "start=$START" >> $GITHUB_OUTPUT
          echo "Starting from line $START"

      - name: Download found flag
        uses: actions/download-artifact@v4
        with:
          name: found
        continue-on-error: true

      - name: Stop if found
        if: hashFiles('found.txt') != ''
        run: |
          echo "Password already found. Stopping A."
          exit 0

      - name: Download dictionary
        run: |
          wget -q https://download.weakpass.com/wordlists/2025/weakpass_4.merged.txt.7z
          7z x weakpass_4.merged.txt.7z -o. -y

      - name: Prepare dictionary slice
        run: |
          START=${{ steps.read.outputs.start }}
          sed -n "${START},999999999p" weakpass_4.merged.txt > dict_part.txt

      - name: Run hashcat and capture progress
        id: crack
        run: |
          START=${{ steps.read.outputs.start }}

          hashcat -m 22000 -a 0 -w 3 \
            --status --status-timer=30 \
            hs/wifi-01.hc22000 dict_part.txt \
            -o result_wifi01.txt \
            2>&1 | tee hashcat.log &

          PID=$!

          while kill -0 $PID 2>/dev/null; do
            sleep 30
            PROG=$(grep "Progress" hashcat.log | tail -1 | awk '{print $2}' | cut -d'/' -f1)
            if [ ! -z "$PROG" ]; then
              CURRENT=$((START + PROG))
              echo $CURRENT > progress.txt
            fi
          done

      - name: Check if found
        id: found
        run: |
          if [ -s result_wifi01.txt ]; then
            echo "FOUND" > found.txt
            echo "found=true" >> $GITHUB_OUTPUT
          else
            echo "found=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload found flag
        if: steps.found.outputs.found == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: found
          path: found.txt

      - name: Upload progress
        if: steps.found.outputs.found == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: progress
          path: progress.txt

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: results
          path: result_wifi01.txt
        continue-on-error: true
