name: Crack A

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["Crack B"]
    types: [completed]

jobs:
  crack:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y hashcat p7zip-full

      - name: Load config
        run: |
          source config.txt
          echo "DICT_URL=$DICT_URL" >> $GITHUB_ENV
          echo "CHUNK_LINES=$CHUNK_LINES" >> $GITHUB_ENV
          echo "HANDSHAKES=$HANDSHAKES" >> $GITHUB_ENV

      - name: Download progress
        uses: actions/download-artifact@v4
        with:
          name: progress
        continue-on-error: true

      - name: Read progress
        id: read
        run: |
          if [ -f progress.txt ]; then
            START=$(cat progress.txt)
          else
            START=1
          fi
          echo "start=$START" >> $GITHUB_OUTPUT

      - name: Check if password already found
        uses: actions/download-artifact@v4
        with:
          name: found
        continue-on-error: true

      - name: Stop if found
        if: hashFiles('found.txt') != ''
        run: |
          echo "Password already found, stopping worker A"
          exit 0

      - name: Stream dictionary chunk and crack
        run: |
          START=${{ steps.read.outputs.start }}
          CHUNK=$CHUNK_LINES
          END=$((START + CHUNK))

          echo "Worker A processing lines $START to $END"

          curl -L "$DICT_URL" | 7z x -si -so | sed -n "${START},${END}p" > dict_chunk.txt

          IFS=',' read -ra HS <<< "$HANDSHAKES"
          for H in "${HS[@]}"; do
            OUT="result_${H}.txt"
            hashcat -m 22000 -a 0 -w 3 --force hs/$H dict_chunk.txt --potfile-disable -o "$OUT"
            if [ -s "$OUT" ]; then
              echo "FOUND" > found.txt
            fi
          done

          echo $END > progress.txt

      - name: Upload progress
        uses: actions/upload-artifact@v4
        with:
          name: progress
          path: progress.txt

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: results
          path: result_*
        continue-on-error: true

      - name: Upload found flag
        if: hashFiles('found.txt') != ''
        uses: actions/upload-artifact@v4
        with:
          name: found
          path: found.txt
