name: Crack A

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["Crack B"]
    types: [completed]

env:
  CHUNK_LINES: 900000000

jobs:
  crack:
    runs-on: ubuntu-latest
    timeout-minutes: 350

    steps:
      - uses: actions/checkout@v3

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y hashcat p7zip-full

      - name: Download done flag
        uses: actions/download-artifact@v4
        with:
          name: done
        continue-on-error: true

      - name: Stop if all chunks done
        if: hashFiles('done.txt') != ''
        run: echo "All chunks processed. Stopping A."

      - name: Download progress
        uses: actions/download-artifact@v4
        with:
          name: progress
        continue-on-error: true

      - name: Read chunk index
        id: read
        run: |
          if [ -f progress.txt ]; then
            CHUNK_INDEX=$(cat progress.txt)
          else
            CHUNK_INDEX=0
          fi
          echo "chunk_index=$CHUNK_INDEX" >> $GITHUB_OUTPUT

      - name: Download dictionary
        run: |
          wget -q https://download.weakpass.com/wordlists/2025/weakpass_4.merged.txt.7z
          7z x weakpass_4.merged.txt.7z -o. -y

      - name: Prepare chunk
        id: chunk
        run: |
          CHUNK_INDEX=${{ steps.read.outputs.chunk_index }}
          CHUNK_LINES=${CHUNK_LINES}

          START_LINE=$((CHUNK_INDEX * CHUNK_LINES + 1))
          END_LINE=$(((CHUNK_INDEX + 1) * CHUNK_LINES))

          echo "Processing lines $START_LINE to $END_LINE"

          sed -n "${START_LINE},${END_LINE}p" weakpass_4.merged.txt > dict_part.txt || true

          if [ ! -s dict_part.txt ]; then
            echo "DONE" > done.txt
          fi

      - name: Upload done flag
        if: hashFiles('done.txt') != ''
        uses: actions/upload-artifact@v4
        with:
          name: done
          path: done.txt

      - name: Stop if no more chunks
        if: hashFiles('done.txt') != ''
        run: echo "No more chunks. Stopping A."

      - name: Pre-increase chunk index (IMPORTANT)
        if: hashFiles('done.txt') == ''
        run: |
          CHUNK_INDEX=${{ steps.read.outputs.chunk_index }}
          NEXT_INDEX=$((CHUNK_INDEX + 1))
          echo $NEXT_INDEX > progress.txt
          echo "Next chunk index: $NEXT_INDEX"

      - name: Upload progress
        if: hashFiles('done.txt') == ''
        uses: actions/upload-artifact@v4
        with:
          name: progress
          path: progress.txt

      - name: Run hashcat
        if: hashFiles('done.txt') == ''
        run: |
          hashcat -m 22000 -a 0 -w 3 \
            hs/wifi-01.hc22000 dict_part.txt \
            -o result_wifi01.txt \
            --potfile-disable || true

      - name: Check if found
        id: found
        if: hashFiles('done.txt') == ''
        run: |
          if [ -s result_wifi01.txt ]; then
            echo "found=true" >> $GITHUB_OUTPUT
          else
            echo "found=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload results
        if: steps.found.outputs.found == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: results
          path: result_wifi01.txt

      - name: Mark all done if found
        if: steps.found.outputs.found == 'true'
        run: echo "FOUND" > done.txt

      - name: Upload done flag if found
        if: steps.found.outputs.found == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: done
          path: done.txt
