name: Crack

on:
  workflow_dispatch:

permissions:
  contents: write
  actions: write

env:
  CHUNK_LINES: 5000000

jobs:

  A:
    runs-on: ubuntu-latest
    if: github.event.inputs.job == 'A' || github.event_name == 'workflow_dispatch'
    timeout-minutes: 350

    steps:
      - uses: actions/checkout@v3

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y hashcat p7zip-full

      - name: Download progress from B
        uses: actions/download-artifact@v4
        with:
          name: progress_B
        continue-on-error: true

      - name: Read chunk index
        id: read
        run: |
          if [ -f progress.txt ]; then
            CHUNK_INDEX=$(cat progress.txt)
          else
            CHUNK_INDEX=0
          fi
          echo "chunk_index=$CHUNK_INDEX" >> $GITHUB_OUTPUT

      - name: Download dictionary
        run: |
          wget -q https://download.weakpass.com/wordlists/2025/weakpass_4.merged.txt.7z
          7z x weakpass_4.merged.txt.7z -o. -y

      - name: Prepare chunk
        run: |
          CHUNK_INDEX=${{ steps.read.outputs.chunk_index }}
          START=$((CHUNK_INDEX * CHUNK_LINES + 1))
          END=$(((CHUNK_INDEX + 1) * CHUNK_LINES))
          sed -n "${START},${END}p" weakpass_4.merged.txt > dict_part.txt || true
          if [ ! -s dict_part.txt ]; then
            echo "DONE" > done.txt
          fi

      - name: Upload done flag
        if: hashFiles('done.txt') != ''
        uses: actions/upload-artifact@v4
        with:
          name: done_A
          path: done.txt

      - name: Stop if done
        if: hashFiles('done.txt') != ''
        run: echo "A finished"

      - name: Pre-increase chunk index
        if: hashFiles('done.txt') == ''
        run: |
          NEXT=$(( ${{ steps.read.outputs.chunk_index }} + 1 ))
          echo $NEXT > progress.txt

      - name: Upload progress
        if: hashFiles('done.txt') == ''
        uses: actions/upload-artifact@v4
        with:
          name: progress_A
          path: progress.txt

      - name: Run hashcat
        if: hashFiles('done.txt') == ''
        run: |
          hashcat -m 22000 -a 0 -w 3 \
            hs/wifi-01.hc22000 dict_part.txt \
            -o result.txt \
            --status --status-timer=60 \
            --potfile-disable || true

      - name: Upload result
        if: hashFiles('result.txt') != ''
        uses: actions/upload-artifact@v4
        with:
          name: result
          path: result.txt

      - name: Trigger B
        if: hashFiles('done.txt') == ''
        run: |
          gh workflow run Crack.yml -f job=B


  B:
    runs-on: ubuntu-latest
    if: github.event.inputs.job == 'B'
    timeout-minutes: 350

    steps:
      - uses: actions/checkout@v3

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y hashcat p7zip-full

      - name: Download progress from A
        uses: actions/download-artifact@v4
        with:
          name: progress_A
        continue-on-error: true

      - name: Read chunk index
        id: read
        run: |
          if [ -f progress.txt ]; then
            CHUNK_INDEX=$(cat progress.txt)
          else
            CHUNK_INDEX=0
          fi
          echo "chunk_index=$CHUNK_INDEX" >> $GITHUB_OUTPUT

      - name: Download dictionary
        run: |
          wget -q https://download.weakpass.com/wordlists/2025/weakpass_4.merged.txt.7z
          7z x weakpass_4.merged.txt.7z -o. -y

      - name: Prepare chunk
        run: |
          CHUNK_INDEX=${{ steps.read.outputs.chunk_index }}
          START=$((CHUNK_INDEX * CHUNK_LINES + 1))
          END=$(((CHUNK_INDEX + 1) * CHUNK_LINES))
          sed -n "${START},${END}p" weakpass_4.merged.txt > dict_part.txt || true
          if [ ! -s dict_part.txt ]; then
            echo "DONE" > done.txt
          fi

      - name: Upload done flag
        if: hashFiles('done.txt') != ''
        uses: actions/upload-artifact@v4
        with:
          name: done_B
          path: done.txt

      - name: Stop if done
        if: hashFiles('done.txt') != ''
        run: echo "B finished"

      - name: Pre-increase chunk index
        if: hashFiles('done.txt') == ''
        run: |
          NEXT=$(( ${{ steps.read.outputs.chunk_index }} + 1 ))
          echo $NEXT > progress.txt

      - name: Upload progress
        if: hashFiles('done.txt') == ''
        uses: actions/upload-artifact@v4
        with:
          name: progress_B
          path: progress.txt

      - name: Run hashcat
        if: hashFiles('done.txt') == ''
        run: |
          hashcat -m 22000 -a 0 -w 3 \
            hs/wifi-01.hc22000 dict_part.txt \
            -o result.txt \
            --status --status-timer=60 \
            --potfile-disable || true

      - name: Upload result
        if: hashFiles('result.txt') != ''
        uses: actions/upload-artifact@v4
        with:
          name: result
          path: result.txt

      - name: Trigger A
        if: hashFiles('done.txt') == ''
        run: |
          gh workflow run Crack.yml -f job=A
