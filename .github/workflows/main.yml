name: slice-streaming

on:
  workflow_dispatch:

jobs:
  slice:
    runs-on: ubuntu-latest
    steps:
      - name: Install p7zip
        run: sudo apt-get update && sudo apt-get install -y p7zip-full

      - name: Download all_in_one.txt.7z
        run: |
          wget -O all_in_one.txt.7z https://download.weakpass.com/wordlists/2088/all_in_one.txt.7z

      - name: Stream extract and slice into 100M-line chunks
        run: |
          mkdir chunks
          file_index=0
          line_count=0
          max_lines=100000000

          # 打开第一个输出文件
          output_file=$(printf "chunks/part_%03d" $file_index)
          echo "Writing to $output_file"

          # 流式解压并逐行处理
          7z x all_in_one.txt.7z -so | while IFS= read -r line; do
            echo "$line" >> "$output_file"
            line_count=$((line_count + 1))

            # 达到 1 亿行 → 切换到下一个文件
            if [ "$line_count" -ge "$max_lines" ]; then
              file_index=$((file_index + 1))
              output_file=$(printf "chunks/part_%03d" $file_index)
              echo "Switching to $output_file"
              line_count=0
            fi
          done

          echo "Done slicing."
